<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #f5576c; font-size: 1.8em; }
        .btn {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-view {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 10px;
        }
        .btn-toggle {
            background: linear-gradient(135deg, #28a745, #20c997);
            padding: 6px 12px;
            font-size: 13px;
            margin: 5px;
        }
        .btn-toggle.uncheck {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #f5576c;
        }
        .stat-label { color: #666; margin-top: 5px; }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 1100px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .tab {
            background: #f8f9fa;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #dee2e6;
        }
        .tab.active {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border-color: #f5576c;
        }
        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        .page-item {
            background: #f8f9fa;
            padding: 12px 8px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9em;
        }
        .page-item:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .page-item.memorized {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            color: #28a745;
        }
        .surah-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .surah-item-modal {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
        }
        .surah-item-modal.memorized {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }
        .surah-item-modal:hover {
            transform: scale(1.02);
        }
        .juz-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .juz-item-modal {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        .juz-item-modal.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }
        .juz-item-modal:hover {
            transform: scale(1.05);
        }
        .hidden { display: none; }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="welcomeText">ğŸ‘¨â€ğŸ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</h1>
        <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸšª</button>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalStudents">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completedHifz">0</div>
            <div class="stat-label">Ø£ØªÙ…ÙˆØ§ Ø§Ù„Ø­ÙØ¸</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="averageProgress">0%</div>
            <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalHalaqas">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</div>
        </div>
    </div>

    <div class="card">
        <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <form id="halaqaForm">
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©:</label>
                <input type="text" id="halaqaName" required>
            </div>
            <button type="submit" class="btn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø©</button>
        </form>
    </div>

    <div class="card">
        <h2>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="studentForm">
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <input type="text" id="studentName" required>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø¹Ù…Ø±:</label>
                <input type="number" id="studentAge" min="5" max="100" required>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø­Ù„Ù‚Ø©:</label>
                <select id="studentHalaqa" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ù„Ù‚Ø©</option>
                </select>
            </div>
            <button type="submit" class="btn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        </form>
    </div>

    <div class="card">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
        <div class="loading" id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="student-grid" id="studentsList"></div>
    </div>
</div>

<!-- Modal Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalStudentName"></h2>
        <p id="modalStudentInfo"></p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchModalTab('pages')">Ø§Ù„ØµÙØ­Ø§Øª</div>
            <div class="tab" onclick="switchModalTab('surahs')">Ø§Ù„Ø³ÙˆØ±</div>
            <div class="tab" onclick="switchModalTab('juzs')">Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</div>
        </div>
        
        <!-- Ø§Ù„ØµÙØ­Ø§Øª -->
        <div id="modalPagesTab">
            <h3>Ø§Ù„ØµÙØ­Ø§Øª (<span id="modalPagesCount">0</span>/604)</h3>
            <div class="pages-grid" id="modalPagesList"></div>
        </div>
        
        <!-- Ø§Ù„Ø³ÙˆØ± -->
        <div id="modalSurahsTab" class="hidden">
            <h3>Ø§Ù„Ø³ÙˆØ± (<span id="modalSurahCount">0</span>/114)</h3>
            <div class="surah-list" id="modalSurahList"></div>
        </div>
        
        <!-- Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ -->
        <div id="modalJuzsTab" class="hidden">
            <h3>Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ (<span id="modalJuzCount">0</span>/30)</h3>
            <div class="juz-list" id="modalJuzList"></div>
        </div>
    </div>
</div>

<script>
// ØªØ­Ø¯ÙŠØ¯ API URL ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø©
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:3000/api'
    : '/api';
let token = localStorage.getItem('token');
let currentViewingStudent = null;

window.addEventListener('DOMContentLoaded', async () => {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    
    if (!token || !user || user.role !== 'teacher') {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¹Ù„Ù…');
        window.location.href = 'teacher-login.html';
        return;
    }
    
    document.getElementById('welcomeText').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name} ğŸ‘¨â€ğŸ«`;
    
    await loadData();
});

async function loadData() {
    await loadHalaqas();
    await loadStudents();
    await loadStatistics();
}

async function loadHalaqas() {
    try {
        const res = await fetch(`${API}/halaqas`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const halaqas = await res.json();
        
        const select = document.getElementById('studentHalaqa');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ù„Ù‚Ø©</option>';
        
        halaqas.forEach(h => {
            const option = document.createElement('option');
            option.value = h._id;
            option.textContent = h.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadStudents() {
    try {
        const res = await fetch(`${API}/students`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const students = await res.json();
        
        document.getElementById('loading').style.display = 'none';
        
        const list = document.getElementById('studentsList');
        list.innerHTML = '';
        
        students.forEach(student => {
            const progress = student.memorization?.overallProgress || 0;
            const pagesCount = student.memorization?.totalPagesMemorized || 0;
            const surahsCount = student.memorization?.totalSurahsMemorized || 0;
            
            const card = document.createElement('div');
            card.className = 'student-card';
            card.innerHTML = `
                <h3>${student.name}</h3>
                <p>Ø§Ù„Ø¹Ù…Ø±: ${student.age} Ø³Ù†Ø©</p>
                <p>Ø§Ù„Ø­Ù„Ù‚Ø©: ${student.halaqa?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <p>Ø§Ù„ØªÙ‚Ø¯Ù…: ${progress}%</p>
                <p>Ø§Ù„ØµÙØ­Ø§Øª: ${pagesCount}/604 | Ø§Ù„Ø³ÙˆØ±: ${surahsCount}/114</p>
                <button class="btn btn-view" onclick="viewStudent('${student._id}')">
                    Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ğŸ‘ï¸
                </button>
            `;
            list.appendChild(card);
        });
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
    }
}

async function loadStatistics() {
    try {
        const res = await fetch(`${API}/statistics`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const stats = await res.json();
        
        document.getElementById('totalStudents').textContent = stats.totalStudents;
        document.getElementById('completedHifz').textContent = stats.completedHifz;
        document.getElementById('averageProgress').textContent = stats.averageProgress + '%';
        document.getElementById('totalHalaqas').textContent = stats.totalHalaqas;
    } catch (error) {
        console.error('Error:', error);
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ù…Ù„Ù teacher.html Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© viewStudent

async function viewStudent(studentId) {
    try {
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        const modal = document.getElementById('studentModal');
        modal.style.display = 'block';
        document.getElementById('modalStudentName').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        document.getElementById('modalStudentInfo').textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
        
        const res = await fetch(`${API}/students/${studentId}/memorization`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        const data = await res.json();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (!data.memorization || !data.memorization.pages || data.memorization.pages.length === 0) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ù„Ù„Ø·Ø§Ù„Ø¨');
        }
        
        currentViewingStudent = { id: studentId, data: data };
        
        document.getElementById('modalStudentName').textContent = data.student.name;
        document.getElementById('modalStudentInfo').textContent = 
            `Ø§Ù„Ø¹Ù…Ø±: ${data.student.age} | Ø§Ù„Ø­Ù„Ù‚Ø©: ${data.student.halaqa?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
        
        displayModalPages(data);
        displayModalSurahs(data);
        displayModalJuzs(data);
        
    } catch (error) {
        console.error('Error:', error);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (error.message.includes('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©')) {
            if (confirm('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø§Ù„Ø¢Ù†ØŸ')) {
                await initializeStudentData(studentId);
                return;
            }
        }
        
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨: ' + error.message);
        closeModal();
    }
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
async function initializeStudentData(studentId) {
    try {
        const modal = document.getElementById('studentModal');
        modal.style.display = 'block';
        document.getElementById('modalStudentName').textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
        document.getElementById('modalStudentInfo').textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†';
        
        const res = await fetch(`${API}/students/${studentId}/initialize`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
            throw new Error('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        alert('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ù†Ø¬Ø§Ø­!');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await viewStudent(studentId);
        await loadStudents();
        
    } catch (error) {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        closeModal();
    }
}

// ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© displayModalPages Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
function displayModalPages(data) {
    try {
        if (!data.memorization || !data.memorization.pages) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙØ­Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        }
        
        const pagesCount = data.memorization.pages.filter(p => p.isMemorized).length;
        document.getElementById('modalPagesCount').textContent = pagesCount;
        
        const pagesList = document.getElementById('modalPagesList');
        pagesList.innerHTML = '';
        
        data.memorization.pages.forEach(page => {
            const pageDiv = document.createElement('div');
            pageDiv.className = `page-item ${page.isMemorized ? 'memorized' : ''}`;
            pageDiv.onclick = () => toggleStudentPage(currentViewingStudent.id, page.pageNumber, !page.isMemorized);
            pageDiv.textContent = page.pageNumber;
            
            pagesList.appendChild(pageDiv);
        });
    } catch (error) {
        console.error('Error in displayModalPages:', error);
        const pagesList = document.getElementById('modalPagesList');
        pagesList.innerHTML = '<p style="text-align: center; color: red;">Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª</p>';
    }
}

// ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© displayModalSurahs
function displayModalSurahs(data) {
    try {
        if (!data.memorization || !data.memorization.surahs) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        }
        
        const surahCount = data.memorization.surahs.filter(s => s.isMemorized).length;
        document.getElementById('modalSurahCount').textContent = surahCount;
        
        const surahList = document.getElementById('modalSurahList');
        surahList.innerHTML = '';
        
        data.memorization.surahs.forEach(surah => {
            const surahPages = data.memorization.pages.filter(p => p.surahNumber === surah.surahNumber);
            const memorizedPages = surahPages.filter(p => p.isMemorized).length;
            
            const surahDiv = document.createElement('div');
            surahDiv.className = `surah-item-modal ${surah.isMemorized ? 'memorized' : ''}`;
            surahDiv.onclick = () => toggleStudentSurah(currentViewingStudent.id, surah.surahNumber, !surah.isMemorized);
            
            surahDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${surah.surahNumber}. ${surah.surahName}</strong>
                        <br>
                        <small>${memorizedPages}/${surahPages.length} ØµÙØ­Ø©</small>
                    </div>
                    <div style="font-size: 1.3em;">
                        ${surah.isMemorized ? 'âœ“' : 'â—‹'}
                    </div>
                </div>
            `;
            
            surahList.appendChild(surahDiv);
        });
    } catch (error) {
        console.error('Error in displayModalSurahs:', error);
        const surahList = document.getElementById('modalSurahList');
        surahList.innerHTML = '<p style="text-align: center; color: red;">Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙˆØ±</p>';
    }
}

// ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© displayModalJuzs
function displayModalJuzs(data) {
    try {
        if (!data.memorization || !data.memorization.juzs) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        }
        
        const juzCount = data.memorization.juzs.filter(j => j.isMemorized).length;
        document.getElementById('modalJuzCount').textContent = juzCount;
        
        const juzList = document.getElementById('modalJuzList');
        juzList.innerHTML = '';
        
        data.memorization.juzs.forEach(juz => {
            const juzDiv = document.createElement('div');
            juzDiv.className = `juz-item-modal ${juz.isMemorized ? 'completed' : ''}`;
            juzDiv.onclick = () => toggleStudentJuz(currentViewingStudent.id, juz.juzNumber, !juz.isMemorized);
            
            juzDiv.innerHTML = `
                <div style="font-size: 1.5em; margin-bottom: 5px;">${juz.juzNumber}</div>
                <div style="font-size: 0.85em;">
                    ${juz.isMemorized ? 'âœ“ Ù…ÙƒØªÙ…Ù„' : juz.progress + '%'}
                </div>
            `;
            
            juzList.appendChild(juzDiv);
        });
    } catch (error) {
        console.error('Error in displayModalJuzs:', error);
        const juzList = document.getElementById('modalJuzList');
        juzList.innerHTML = '<p style="text-align: center; color: red;">Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</p>';
    }
}
function displayModalPages(data) {
    const pagesCount = data.memorization.pages.filter(p => p.isMemorized).length;
    document.getElementById('modalPagesCount').textContent = pagesCount;
    
    const pagesList = document.getElementById('modalPagesList');
    pagesList.innerHTML = '';
    
    data.memorization.pages.forEach(page => {
        const pageDiv = document.createElement('div');
        pageDiv.className = `page-item ${page.isMemorized ? 'memorized' : ''}`;
        pageDiv.onclick = () => toggleStudentPage(currentViewingStudent.id, page.pageNumber, !page.isMemorized);
        pageDiv.textContent = page.pageNumber;
        pageDiv.title = `ØµÙØ­Ø© ${page.pageNumber} - Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„`;
        
        pagesList.appendChild(pageDiv);
    });
}

function displayModalSurahs(data) {
    const surahCount = data.memorization.surahs.filter(s => s.isMemorized).length;
    document.getElementById('modalSurahCount').textContent = surahCount;
    
    const surahList = document.getElementById('modalSurahList');
    surahList.innerHTML = '';
    
    data.memorization.surahs.forEach(surah => {
        const surahPages = data.memorization.pages.filter(p => p.surahNumber === surah.surahNumber);
        const memorizedPages = surahPages.filter(p => p.isMemorized).length;
        
        const surahDiv = document.createElement('div');
        surahDiv.className = `surah-item-modal ${surah.isMemorized ? 'memorized' : ''}`;
        surahDiv.onclick = () => toggleStudentSurah(currentViewingStudent.id, surah.surahNumber, !surah.isMemorized);
        surahDiv.title = 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„';
        
        surahDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${surah.surahNumber}. ${surah.surahName}</strong>
                    <br>
                    <small>${memorizedPages}/${surahPages.length} ØµÙØ­Ø©</small>
                </div>
                <div style="font-size: 1.3em;">
                    ${surah.isMemorized ? 'âœ“' : 'â—‹'}
                </div>
            </div>
        `;
        
        surahList.appendChild(surahDiv);
    });
}

function displayModalJuzs(data) {
    const juzCount = data.memorization.juzs.filter(j => j.isMemorized).length;
    document.getElementById('modalJuzCount').textContent = juzCount;
    
    const juzList = document.getElementById('modalJuzList');
    juzList.innerHTML = '';
    
    data.memorization.juzs.forEach(juz => {
        const juzDiv = document.createElement('div');
        juzDiv.className = `juz-item-modal ${juz.isMemorized ? 'completed' : ''}`;
        juzDiv.onclick = () => toggleStudentJuz(currentViewingStudent.id, juz.juzNumber, !juz.isMemorized);
        juzDiv.title = 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„';
        
        juzDiv.innerHTML = `
            <div style="font-size: 1.5em; margin-bottom: 5px;">${juz.juzNumber}</div>
            <div style="font-size: 0.85em;">
                ${juz.isMemorized ? 'âœ“ Ù…ÙƒØªÙ…Ù„' : juz.progress + '%'}
            </div>
        `;
        
        juzList.appendChild(juzDiv);
    });
}

async function toggleStudentPage(studentId, pageNumber, isMemorized) {
    try {
        const res = await fetch(`${API}/students/${studentId}/page/${pageNumber}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isMemorized })
        });
        
        if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
        await viewStudent(studentId);
        await loadStudents();
        await loadStatistics();
        
    } catch (error) {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙØ­Ø©');
    }
}

async function toggleStudentSurah(studentId, surahNumber, isMemorized) {
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³ÙˆØ±Ø© ${surahNumber} ${isMemorized ? 'ÙƒÙ…Ø­ÙÙˆØ¸Ø©' : 'ÙƒØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©'}ØŸ`)) {
        return;
    }
    
    try {
        const res = await fetch(`${API}/students/${studentId}/surah/${surahNumber}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isMemorized })
        });
        
        if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        
        await viewStudent(studentId);
        await loadStudents();
        await loadStatistics();
        
    } catch (error) {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆØ±Ø©');
    }
}

async function toggleStudentJuz(studentId, juzNumber, isMemorized) {
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø²Ø¡ ${juzNumber} ${isMemorized ? 'ÙƒÙ…ÙƒØªÙ…Ù„' : 'ÙƒØºÙŠØ± Ù…ÙƒØªÙ…Ù„'}ØŸ\nØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø²Ø¡.`)) {
        return;
    }
    
    try {
        const res = await fetch(`${API}/students/${studentId}/juz/${juzNumber}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isMemorized })
        });
        
        if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø²Ø¡');
        
        await viewStudent(studentId);
        await loadStudents();
        await loadStatistics();
        
    } catch (error) {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø²Ø¡');
    }
}

function switchModalTab(tab) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    document.getElementById('modalPagesTab').classList.toggle('hidden', tab !== 'pages');
    document.getElementById('modalSurahsTab').classList.toggle('hidden', tab !== 'surahs');
    document.getElementById('modalJuzsTab').classList.toggle('hidden', tab !== 'juzs');
}

function closeModal() {
    document.getElementById('studentModal').style.display = 'none';
    currentViewingStudent = null;
}

window.onclick = function(event) {
    const modal = document.getElementById('studentModal');
    if (event.target == modal) {
        closeModal();
    }
}

document.getElementById('halaqaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('halaqaName').value;
    
    try {
        const res = await fetch(`${API}/halaqas`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name })
        });
        
        if (!res.ok) throw new Error('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø©');
        
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        document.getElementById('halaqaForm').reset();
        await loadData();
    } catch (error) {
        alert(error.message);
    }
});

document.getElementById('studentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('studentName').value;
    const age = parseInt(document.getElementById('studentAge').value);
    const halaqaId = document.getElementById('studentHalaqa').value;
    
    try {
        const res = await fetch(`${API}/students`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, age, halaqaId })
        });
        
        if (!res.ok) throw new Error('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨');
        
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
        document.getElementById('studentForm').reset();
        await loadData();
    } catch (error) {
        alert(error.message);
    }
});

function logout() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'teacher-login.html';
    }
}
</script>

</body>
</html>